{{>partial_header}}

from unittest.mock import MagicMock

from {{packageName}}.api_client import ApiClient
{{#operations}}

from {{packageName}}.api.{{classFilename}} import {{classname}}


class Test{{classname}}:
    """{{classname}} unit tests"""

    def setup_method(self):
        """Set up test fixtures before each test method."""
        self.api_client = MagicMock(spec=ApiClient)
        self.api_client.select_header_accept.return_value = "application/json"
        self.api_client.select_header_content_type.return_value = "application/json"
        self.api = {{classname}}(api_client=self.api_client)

    # ------------------------------------------------------------------ #
    #  Instantiation
    # ------------------------------------------------------------------ #
    def test_instantiation_with_mock_client(self):
        """{{classname}} can be created with a mock ApiClient."""
        assert isinstance(self.api, {{classname}})
        assert self.api.api_client is self.api_client

    # ------------------------------------------------------------------ #
    #  Method existence
    # ------------------------------------------------------------------ #
{{#operation}}
    def test_has_{{operationId}}(self):
        assert callable(getattr(self.api, "{{operationId}}", None))

{{/operation}}

    def test_has_with_http_info_variants(self):
        for method in (
{{#operation}}
            "{{operationId}}_with_http_info",
{{/operation}}
        ):
            assert callable(getattr(self.api, method, None)), f"{method} should exist"

    def test_has_without_preload_content_variants(self):
        for method in (
{{#operation}}
            "{{operationId}}_without_preload_content",
{{/operation}}
        ):
            assert callable(getattr(self.api, method, None)), f"{method} should exist"

{{#operation}}
    # ------------------------------------------------------------------ #
    #  _{{operationId}}_serialize
    # ------------------------------------------------------------------ #
    def _call_{{operationId}}_serialize(self, **overrides):
        """Helper to call _{{operationId}}_serialize with defaults."""
        defaults = {
{{#allParams}}
{{#isPathParam}}
            "{{paramName}}": 42,
{{/isPathParam}}
{{#isQueryParam}}
            "{{paramName}}": None,
{{/isQueryParam}}
{{#isBodyParam}}
            "{{paramName}}": MagicMock(),
{{/isBodyParam}}
{{/allParams}}
            "_request_auth": None,
            "_content_type": None,
            "_headers": None,
            "_host_index": 0,
        }
        defaults.update(overrides)
        self.api._{{operationId}}_serialize(**defaults)
        return self.api_client.param_serialize.call_args.kwargs

    def test_{{operationId}}_serialize_method_and_path(self):
        """_{{operationId}}_serialize uses {{httpMethod}} {{path}}."""
        kw = self._call_{{operationId}}_serialize()
        assert kw["method"] == "{{httpMethod}}"
        assert kw["resource_path"] == "{{path}}"

{{#hasAuthMethods}}
    def test_{{operationId}}_serialize_bearer_auth(self):
        """_{{operationId}}_serialize requires {{#authMethods}}{{name}}{{/authMethods}}."""
        kw = self._call_{{operationId}}_serialize()
        assert kw["auth_settings"] == [{{#authMethods}}"{{name}}"{{^-last}}, {{/-last}}{{/authMethods}}]
{{/hasAuthMethods}}
{{^hasAuthMethods}}
    def test_{{operationId}}_serialize_no_auth(self):
        """_{{operationId}}_serialize uses no auth."""
        kw = self._call_{{operationId}}_serialize()
        assert kw["auth_settings"] == []
{{/hasAuthMethods}}

{{#hasBodyParam}}
    def test_{{operationId}}_serialize_body(self):
        """_{{operationId}}_serialize forwards the request body."""
        mock_body = MagicMock()
        kw = self._call_{{operationId}}_serialize({{#bodyParam}}{{paramName}}{{/bodyParam}}=mock_body)
        assert kw["body"] is mock_body
{{/hasBodyParam}}
{{^hasBodyParam}}
    def test_{{operationId}}_serialize_no_body(self):
        """_{{operationId}}_serialize sends no body."""
        kw = self._call_{{operationId}}_serialize()
        assert kw["body"] is None
{{/hasBodyParam}}

{{#hasPathParams}}
    def test_{{operationId}}_serialize_path_params(self):
        """_{{operationId}}_serialize passes path parameters."""
        kw = self._call_{{operationId}}_serialize(
{{#pathParams}}
            {{paramName}}=99,
{{/pathParams}}
        )
        assert kw["path_params"] == {
{{#pathParams}}
            "{{baseName}}": 99,
{{/pathParams}}
        }
{{/hasPathParams}}
{{^hasPathParams}}
    def test_{{operationId}}_serialize_no_path_params(self):
        """_{{operationId}}_serialize has no path parameters."""
        kw = self._call_{{operationId}}_serialize()
        assert kw["path_params"] == {}
{{/hasPathParams}}

{{#hasQueryParams}}
    def test_{{operationId}}_serialize_no_query_when_none(self):
        """Omits query params when all are None."""
        kw = self._call_{{operationId}}_serialize()
        assert kw["query_params"] == []

{{#queryParams}}
    def test_{{operationId}}_serialize_{{paramName}}(self):
        """Includes {{baseName}} query param."""
{{#isInteger}}
        kw = self._call_{{operationId}}_serialize({{paramName}}=10)
        assert ("{{baseName}}", 10) in kw["query_params"]
{{/isInteger}}
{{#isLong}}
        kw = self._call_{{operationId}}_serialize({{paramName}}=10)
        assert ("{{baseName}}", 10) in kw["query_params"]
{{/isLong}}
{{#isString}}
        kw = self._call_{{operationId}}_serialize({{paramName}}="test_value")
        assert ("{{baseName}}", "test_value") in kw["query_params"]
{{/isString}}

{{/queryParams}}
{{/hasQueryParams}}
{{^hasQueryParams}}
    def test_{{operationId}}_serialize_no_query_params(self):
        """_{{operationId}}_serialize has no query parameters."""
        kw = self._call_{{operationId}}_serialize()
        assert kw["query_params"] == []
{{/hasQueryParams}}

{{/operation}}
{{/operations}}
